<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부동산 매물 지도</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .region-list {
            list-style: none;
        }

        .region-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .region-item:hover {
            background: #e0e0e0;
        }

        .region-item.active {
            background: #FFE500;
            font-weight: bold;
        }

        .property-count {
            color: #666;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .property-detail {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
        }

        .property-detail.show {
            display: block;
        }

        .property-detail h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .property-detail .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .property-info {
            margin-top: 15px;
        }

        .property-info p {
            margin: 8px 0;
            color: #666;
        }

        .property-info .price {
            font-size: 1.3em;
            font-weight: bold;
            color: #FF6B6B;
        }
    </style>
</head>
<body>
    <!-- 사이드바: 지역 목록 -->
    <div class="sidebar">
        <h2>지역별 매물</h2>
        <ul class="region-list" id="regionList">
            <!-- 동적으로 생성됨 -->
        </ul>
    </div>

    <!-- 지도 -->
    <div id="map" style="margin-left: 300px;"></div>

    <!-- 매물 상세 정보 -->
    <div class="property-detail" id="propertyDetail">
        <button class="close-btn" onclick="closePropertyDetail()">&times;</button>
        <h3 id="propertyTitle"></h3>
        <div class="property-info" id="propertyInfo"></div>
    </div>

    <script>
        // 카카오맵 API 키 설정
        const KAKAO_API_KEY = '3bb53901127a0dc129ccb44d96c97a85';
        
        let map;
        let markers = [];
        let currentRegion = null;
        let propertyData = [];

        // 매물 데이터 예시 (나중에 서버나 로컬스토리지에서 불러올 수 있음)
        const sampleProperties = [
            { id: 1, name: '해운대 오피스텔 A', region: '해운대구', address: '해운대구 해운대해변로 264', price: '3억 5천만원', type: '오피스텔', area: '33㎡', lat: 35.1631, lng: 129.1636 },
            { id: 2, name: '해운대 아파트 B', region: '해운대구', address: '해운대구 우동 1234', price: '8억원', type: '아파트', area: '84㎡', lat: 35.1640, lng: 129.1645 },
            { id: 3, name: '해운대 원룸 C', region: '해운대구', address: '해운대구 중동 567', price: '1억 2천만원', type: '원룸', area: '25㎡', lat: 35.1620, lng: 129.1625 },
            { id: 4, name: '해운대 상가 D', region: '해운대구', address: '해운대구 센텀시티 789', price: '12억원', type: '상가', area: '120㎡', lat: 35.1650, lng: 129.1655 },
            { id: 5, name: '해운대 오피스텔 E', region: '해운대구', address: '해운대구 좌동 1011', price: '2억 8천만원', type: '오피스텔', area: '28㎡', lat: 35.1610, lng: 129.1615 },
            { id: 6, name: '해운대 아파트 F', region: '해운대구', address: '해운대구 재송동 1213', price: '9억 5천만원', type: '아파트', area: '95㎡', lat: 35.1660, lng: 129.1665 },
            { id: 7, name: '해운대 원룸 G', region: '해운대구', address: '해운대구 우동 1415', price: '1억원', type: '원룸', area: '22㎡', lat: 35.1670, lng: 129.1675 },
            { id: 8, name: '해운대 상가 H', region: '해운대구', address: '해운대구 중동 1617', price: '15억원', type: '상가', area: '150㎡', lat: 35.1680, lng: 129.1685 },
            { id: 9, name: '해운대 오피스텔 I', region: '해운대구', address: '해운대구 센텀시티 1819', price: '4억원', type: '오피스텔', area: '35㎡', lat: 35.1690, lng: 129.1695 },
            { id: 10, name: '해운대 아파트 J', region: '해운대구', address: '해운대구 좌동 2021', price: '7억 5천만원', type: '아파트', area: '78㎡', lat: 35.1700, lng: 129.1705 },
            { id: 11, name: '해운대 원룸 K', region: '해운대구', address: '해운대구 재송동 2223', price: '1억 5천만원', type: '원룸', area: '26㎡', lat: 35.1710, lng: 129.1715 },
            { id: 12, name: '부산 남포동 상가', region: '부산', address: '중구 남포동 100', price: '20억원', type: '상가', area: '200㎡', lat: 35.0979, lng: 129.0304 }
        ];

        // 카카오맵 스크립트 동적 로드
        function loadKakaoMapScript() {
            return new Promise((resolve, reject) => {
                // 이미 로드되어 있는지 확인
                if (typeof kakao !== 'undefined' && kakao.maps) {
                    resolve();
                    return;
                }

                // 현재 도메인 확인
                const currentUrl = window.location.origin;
                console.log('현재 접속 URL:', currentUrl);

                // 스크립트 태그 생성
                const script = document.createElement('script');
                script.type = 'text/javascript';
                // 프로토콜 명시적으로 지정
                const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                script.src = `${protocol}//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_API_KEY}`;
                script.async = true;
                
                script.onload = () => {
                    // 약간의 지연 후 확인 (API 초기화 시간 필요)
                    setTimeout(() => {
                        if (typeof kakao !== 'undefined' && kakao.maps) {
                            console.log('카카오맵 API 로드 성공');
                            resolve();
                        } else {
                            reject(new Error('카카오맵 API 객체를 찾을 수 없습니다.'));
                        }
                    }, 100);
                };
                
                script.onerror = (error) => {
                    console.error('카카오맵 스크립트 로드 실패:', error);
                    console.error('현재 도메인:', currentUrl);
                    console.error('등록 필요 도메인:', currentUrl);
                    reject(new Error(`카카오맵 스크립트를 로드할 수 없습니다.\n\n현재 도메인: ${currentUrl}\n\n카카오 개발자 콘솔에서 다음 도메인을 플랫폼에 등록해주세요:\n1. https://developers.kakao.com 접속\n2. 내 애플리케이션 > 앱 설정 > 플랫폼\n3. Web 플랫폼 등록\n4. 사이트 도메인: ${currentUrl}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // 카카오맵 초기화
        window.onload = async function() {
            try {
                await loadKakaoMapScript();
                initMap();
            } catch (error) {
                console.error('카카오맵 초기화 실패:', error);
                const currentUrl = window.location.origin;
                alert(`카카오맵을 불러올 수 없습니다.\n\n에러: ${error.message}\n\n현재 도메인: ${currentUrl}\n\n카카오 개발자 콘솔에서 플랫폼 설정을 확인해주세요:\n1. https://developers.kakao.com 접속\n2. 내 애플리케이션 > 앱 설정 > 플랫폼\n3. Web 플랫폼 등록\n4. 사이트 도메인에 "${currentUrl}" 정확히 등록\n5. 저장 후 2-3분 대기`);
            }
        };

        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(35.1631, 129.1636), // 해운대 중심
                level: 5
            };
            map = new kakao.maps.Map(container, options);

            // 매물 데이터 로드 (저장된 데이터가 있으면 불러오고, 없으면 예시 데이터 사용)
            loadProperties();
            if (propertyData.length === 0) {
                propertyData = sampleProperties;
            }
            
            // 지역별 매물 그룹화
            const regionGroups = groupByRegion(propertyData);
            
            // 사이드바에 지역 목록 표시
            renderRegionList(regionGroups);
            
            // 전체 매물 표시
            displayProperties(propertyData);
        }

        // 지역별로 매물 그룹화
        function groupByRegion(properties) {
            const groups = {};
            properties.forEach(property => {
                if (!groups[property.region]) {
                    groups[property.region] = [];
                }
                groups[property.region].push(property);
            });
            return groups;
        }

        // 사이드바에 지역 목록 렌더링
        function renderRegionList(regionGroups) {
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';

            Object.keys(regionGroups).forEach(region => {
                const count = regionGroups[region].length;
                const li = document.createElement('li');
                li.className = 'region-item';
                li.textContent = region;
                li.innerHTML = `${region} <span class="property-count">(${count}건)</span>`;
                li.onclick = () => filterByRegion(region, regionGroups[region]);
                regionList.appendChild(li);
            });

            // 전체 보기 추가
            const allLi = document.createElement('li');
            allLi.className = 'region-item active';
            allLi.innerHTML = `전체 <span class="property-count">(${propertyData.length}건)</span>`;
            allLi.onclick = () => filterByRegion(null, propertyData);
            regionList.insertBefore(allLi, regionList.firstChild);
        }

        // 지역별 필터링
        function filterByRegion(region, properties) {
            currentRegion = region;
            
            // 활성화 상태 업데이트
            document.querySelectorAll('.region-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.region-item').classList.add('active');

            // 기존 마커 제거
            clearMarkers();

            // 선택된 지역의 매물만 표시
            displayProperties(properties);

            // 지도 중심 이동
            if (properties.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                properties.forEach(property => {
                    bounds.extend(new kakao.maps.LatLng(property.lat, property.lng));
                });
                map.setBounds(bounds);
            }
        }

        // 매물 표시
        function displayProperties(properties) {
            properties.forEach(property => {
                const marker = createMarker(property);
                markers.push(marker);
            });

            // 클러스터링 (여러 마커가 가까이 있을 때)
            if (markers.length > 0) {
                const clusterer = new kakao.maps.MarkerClusterer({
                    map: map,
                    markers: markers,
                    gridSize: 60,
                    averageCenter: true,
                    minLevel: 6
                });
            }
        }

        // 마커 생성
        function createMarker(property) {
            const markerPosition = new kakao.maps.LatLng(property.lat, property.lng);
            
            // 커스텀 마커 이미지 (선택사항)
            const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
            const imageSize = new kakao.maps.Size(24, 35);
            const imageOption = { offset: new kakao.maps.Point(12, 35) };
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            
            const marker = new kakao.maps.Marker({
                position: markerPosition,
                image: markerImage
            });

            marker.setMap(map);

            // 마커 클릭 이벤트
            kakao.maps.event.addListener(marker, 'click', () => {
                showPropertyDetail(property);
            });

            return marker;
        }

        // 매물 상세 정보 표시
        function showPropertyDetail(property) {
            const detailDiv = document.getElementById('propertyDetail');
            const titleDiv = document.getElementById('propertyTitle');
            const infoDiv = document.getElementById('propertyInfo');

            titleDiv.textContent = property.name;
            infoDiv.innerHTML = `
                <p class="price">${property.price}</p>
                <p><strong>지역:</strong> ${property.region}</p>
                <p><strong>주소:</strong> ${property.address}</p>
                <p><strong>타입:</strong> ${property.type}</p>
                <p><strong>면적:</strong> ${property.area}</p>
            `;

            detailDiv.classList.add('show');

            // 지도 중심을 해당 매물로 이동
            map.setCenter(new kakao.maps.LatLng(property.lat, property.lng));
            map.setLevel(3);
        }

        // 상세 정보 닫기
        function closePropertyDetail() {
            document.getElementById('propertyDetail').classList.remove('show');
        }

        // 마커 제거
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        // 매물 데이터 저장 (로컬스토리지 예시)
        function saveProperty(property) {
            propertyData.push(property);
            localStorage.setItem('properties', JSON.stringify(propertyData));
            
            // 지역 목록 업데이트
            const regionGroups = groupByRegion(propertyData);
            renderRegionList(regionGroups);
            
            // 지도 업데이트
            clearMarkers();
            displayProperties(currentRegion ? 
                regionGroups[currentRegion] : 
                propertyData
            );
        }

        // 매물 데이터 불러오기 (로컬스토리지 예시)
        function loadProperties() {
            const saved = localStorage.getItem('properties');
            if (saved) {
                propertyData = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>

